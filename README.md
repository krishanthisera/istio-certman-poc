# istio-certman-poc
Developing POC for ISTIO with Cert-Manager.  

*Note that the Terraform implementation required to be optimised since the implementation is focused on the maximum readability for learning*  

*In a scenario where you need to scale the EKS. Change the note count.*

# Dependencies
1. Terraform
2. AWS Account

# How to run -- Deployment
1. Clone the repo  
`git clone https://github.com/krishanthisera/istio-certman-poc.git`  
2. cd into the terraform directory and execute terraform plan  
`terraform plan -out=istio.tfplan`  
3. Apply terraform plan  
`terraform apply "istio.tfplan`  
4. Configure EKS config  
`terraform output kubectl_config > ~/.kube/config`  

5. Create Istio name space:  
`kubectl create ns istio-system`  
6. Install CRD  
`kubectl apply -f istio-certman-poc/istio-init/istio-crd.yaml --namespace=istio-system`  
7. Install Istio resources  
`kubectl apply -f istio-certman-poc/istio-init/istio-res.yaml --namespace=istio-system`  
8. Verify the LB  
`kubectl get svc -n istio-system`  
9. Uncomment Terraform ROUTE53 settings to automate the DNS config and run terraform again  
```sh
    terraform plan -out=istio.tfplan
    terraform apply istio.tfplan
```
10. Create Cert-Manager Namespace  
`kubectl create ns cert-manager`  
11. Install Cert-Manger  
`kubectl apply -f cert-manager/cert-man.yaml -n cert-manager`  

# How to run - Ingress Testing
1. Deploy the demo app  
`kubectl apply -f demo-app/bookinfo.yaml`  
2. Configure the Gateway and VirtualService - optional  
```sh
    kubectl apply -f demo-app/bookinfo.yaml
    kubectl apply -f demo-app/ingress.yaml # Change the port to port 80 prior to run
```
3. Verify in the browser  
`http://book.d3v0ps.com.au/`  

4. Delete the Gateway resource  
`kubectl delete -f demo-app/ingress.yaml`  

# How to run - Cert-Manager Configs  
1. Create the issuer  
`kubectl apply -f cert-manager-configs/lets-enc-staging-issuer.yaml`  
2. Verify the issuer  
`kubectl describe issuer -n istio-system`  
if issuer ready  
3. Create `istio-autogenerated-k8s-ingress` to convert ingress objects to ISTIO resources  
`kubectl apply -f cert-manager-configs/istio-autogenerated-k8s-ingress.yaml`  
4. Create the certificate  
`kubectl apply -f cert-manager-configs/book-cert.yaml`  

# How to run - Complete the setup  
1. Rerun the gateway configs for book-info  
`kubectl apply -f demo-app/ingress.yaml`  
2. Test Connectivity using browser  

# How to run - Production Setup  
1. Create production issuer  
`kubectl apply -f cert-manager-configs/lets-enc-prod-issuer.yaml`  
2. Verify the issuer  
`kubectl describe  Issuer -n istio-system letsencrypt-prod`  
3. Create new certificate referring the production issuer  




